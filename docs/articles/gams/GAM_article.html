<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-08-22">
<meta name="description" content="Building intuition on how GAMs work and when they are useful">

<title>Nicole Sorensen - What are Generalized Additive Models (GAMs) and when should you use them?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Nicole Sorensen</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../articles.html"> 
<span class="menu-text">Articles</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/nicole-e-sorensen/" target="_blank"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/nicolesorense" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://nicolesorense.github.io/website/assets/nicole_sorensen_resume_general.pdf" target="_blank"> <i class="bi bi-file-earmark-pdf-fill" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
  <ul>
  <li><a href="#what-are-gams" id="toc-what-are-gams" class="nav-link active" data-scroll-target="#what-are-gams">What are GAMs?</a></li>
  <li><a href="#when-to-use-gams" id="toc-when-to-use-gams" class="nav-link" data-scroll-target="#when-to-use-gams">When to use GAMs?</a></li>
  <li><a href="#when-not-to-use-gams" id="toc-when-not-to-use-gams" class="nav-link" data-scroll-target="#when-not-to-use-gams">When NOT to use GAMs?</a></li>
  <li><a href="#why-use-gams" id="toc-why-use-gams" class="nav-link" data-scroll-target="#why-use-gams">Why use GAMs?</a></li>
  <li><a href="#how-are-the-functions-determined" id="toc-how-are-the-functions-determined" class="nav-link" data-scroll-target="#how-are-the-functions-determined">How are the functions determined?</a></li>
  <li><a href="#how-to-interpret-gams" id="toc-how-to-interpret-gams" class="nav-link" data-scroll-target="#how-to-interpret-gams">How to interpret GAMs?</a>
  <ul class="collapse">
  <li><a href="#categorical-variables" id="toc-categorical-variables" class="nav-link" data-scroll-target="#categorical-variables">Categorical variables</a></li>
  <li><a href="#what-about-interactions" id="toc-what-about-interactions" class="nav-link" data-scroll-target="#what-about-interactions">What about interactions?</a></li>
  </ul></li>
  <li><a href="#model-assumptions" id="toc-model-assumptions" class="nav-link" data-scroll-target="#model-assumptions">Model assumptions</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<div class="quarto-about-solana column-body content">
  <div class="about-entity">
    <div class="entity-contents">
      <header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">What are Generalized Additive Models (GAMs) and when should you use them?</h1>
</div>
<div>
  <div class="description">
    Building intuition on how GAMs work and when they are useful
  </div>
</div>
<div class="quarto-title-meta">
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 22, 2024</p>
    </div>
  </div>
  </div>
</header> 
      <div class="about-contents"><main class="content" id="quarto-document-content">

<section id="what-are-gams" class="level2">
<h2 data-anchor-id="what-are-gams">What are GAMs?</h2>
<p>GAMs are an advanced version of linear models that <strong>can handle nonlinear patterns</strong> in the data. Instead of assuming a straight-line relationship between the predictors and the outcome, GAMs use <strong>smooth curves</strong> to capture more complex relationships. The main ideas behind GAMs are:</p>
<ul>
<li><p><strong>Nonlinear predictor effects:</strong> The relationship between each predictor and the outcome is modeled using smooth curves, which can capture non-linear trends.</p></li>
<li><p><strong>Additivity:</strong> The final prediction is made by adding up the effects of each predictor.</p></li>
</ul>
<p><img src="images/gam_visual.png" class="img-fluid"></p>
<p>This is actually quite similar to linear regression! The main difference is that GAMs don’t require the relationship between each predictor and the outcome to be a straight line.</p>
<p>Even though GAMs allow for non-linear effects, they are still considered <strong>linear models</strong> because the smooth functions are simply <strong>added together</strong>. The functions don’t interact or get multiplied in complicated ways, keeping the overall model linear.</p>
<p>Here is how the two compare:</p>
<p>In linear models:</p>
<p><span class="math display">\[
f(x) = \beta _0 + \beta_1x_1 + \beta_2x_2 + \dotsc + \beta_nx_n
\]</span></p>
<p>The coefficients are just constants.</p>
<p>In GAMs:</p>
<p><span class="math display">\[
f(x) = \beta_0 + s_1(x_1) + s_2(x_2) + \dots + s_n(x_n)
\]</span></p>
<p>The coefficients are replaced by <strong>functions</strong> denoted by <span class="math inline">\(s_i\)</span>. These functions are <strong>non-parametric</strong> meaning that each function <span class="math inline">\(s_i\)</span> is learned from the data, without assuming a specific shape (like linear or quadratic). This makes GAMs more flexible compared to linear models, where each predictor is simply multiplied by a constant <span class="math inline">\(\beta_i\)</span>.</p>
<p>In fact, linear models are just special cases of GAMs where each <span class="math inline">\(s_i\)</span> is just a linear function instead of a smooth curve.</p>
</section>
<section id="when-to-use-gams" class="level2">
<h2 data-anchor-id="when-to-use-gams">When to use GAMs?</h2>
<p>Is a GAM the right choice for your problem? GAMs are useful when you see potential signs of nonlinearity in your data between a predictor variable and your response variable. This nonlinearity may show up in exploratory data analysis (EDA) with scatter plots that don’t look linear, or when you know from experience that the relationship isn’t linear.</p>
<p><strong>Consider a simple example:</strong> the relationship between age and the number of sit ups someone can perform. We might expect that people maintain their physical fitness into their 30s, but as they get older their physical ability starts to decline.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(datasets)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gratia)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>performance_df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/nicolesorense/GAM-article-resources/main/bodyPerformance.csv"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># performance_df &lt;- read_csv("/Users/nicolesorensen/Dropbox/bodyPerformance.csv")</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>performance_df <span class="ot">&lt;-</span> performance_df <span class="sc">|&gt;</span> </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>()</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">64</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>sampled_data <span class="ot">&lt;-</span> performance_df <span class="sc">|&gt;</span> <span class="fu">sample_n</span>(<span class="dv">1000</span>)  <span class="co"># Sample for visibility</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>sampled_data <span class="sc">|&gt;</span> </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> sit_ups_counts)) <span class="sc">+</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>) <span class="sc">+</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Number of sit-ups"</span>, <span class="at">title =</span> <span class="st">"Number of sit-ups by age"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="GAM_article_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this case, a <strong>nonlinear</strong> pattern is obvious in the data so a linear model would fall short.</p>
<p>To see how the GAM model accounts for this nonlinear relationship, we can visualize the partial effect that age has on the outcome variable, predicted number of sit-ups.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>gam_hr <span class="ot">&lt;-</span> <span class="fu">gam</span>(sit_ups_counts <span class="sc">~</span> <span class="fu">s</span>(age), <span class="at">data =</span> sampled_data)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>partial_effect_plot <span class="ot">&lt;-</span> <span class="fu">draw</span>(gam_hr, <span class="at">residuals =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>partial_effect_plot <span class="sc">+</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Partial effect of age on predicted number of sit-ups'</span>, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">'s(age)'</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">'Age'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="GAM_article_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The graph above shows the smooth function of age to predict number of sit-ups. We see that people between 20 and 30 have a positive partial effect, so they increase the predicted number of sit-ups, while people over 30 show a decline, which aligns with our expectations that older people are likely to do less sit-ups.</p>
<p>These partial effect plots are a major interpretability advantage of GAMs over other nonlinear models. They show the <strong>individual effect of each predictor on the outcome</strong> without the complexity of interactions and high dimensional surfaces.</p>
</section>
<section id="when-not-to-use-gams" class="level2">
<h2 data-anchor-id="when-not-to-use-gams">When NOT to use GAMs?</h2>
<p>How do I know when a GAM is <strong>not</strong> appropriate for my use case? Avoid GAMs when…</p>
<ul>
<li><p><strong>You need automatic interaction modeling:</strong> Since GAMs are additive, they might miss interactions between variables. While interaction terms can be added manually (as with linear regression), other models like random forests, gradient boosting machines, or support vector machines are better for capturing interactions automatically—especially if interpretability is not your primary concern.</p></li>
<li><p><strong>You only care about prediction accuracy:</strong> In situations where prediction accuracy is your main goal, such as in Kaggle competitions, GAMs usually perform worse than more flexible models like XGBoost, LightGBM, or neural networks.</p></li>
<li><p><strong>All relationships are expected to be linear:</strong> If your predictor-response relationships are expected to be linear, a linear regression model would suffice since it is simpler and more easily interpretable.</p></li>
<li><p><strong>There is high concurvity between smooth functions:</strong> Concurvity is the GAM version of multicollinearity with linear regression. A GAM has high concurvity when one of the smooth functions is a sum of the others. This makes it difficult for the model to estimate the separate effects of predictors. You can check for concurvity using the <code>concurvity()</code> function in R, and if concurvity is high, this could be resolved by combining / removing predictors or switching to a different model.</p></li>
</ul>
</section>
<section id="why-use-gams" class="level2">
<h2 data-anchor-id="why-use-gams">Why use GAMs?</h2>
<p>Life is not linear!</p>
<p>Although linear models are often sufficient to model many relationships, sometimes we do want to capture some complexity without oversimplifying it. GAMs are often advantageous over more complex models because their additive nature allows us to visualize the separate effects of each predictor on the outcome variable. This makes them <strong>much more interpretable</strong> than other “black-box” models like random forests and neural networks.</p>
<p><img src="images/interp_flex_tradeoff.png" class="img-fluid"></p>
<p>(from Introduction to Statistical Learning)</p>
<p>In this above representation of the tradeoff between flexibility and interpretability from “An Introduction to Statistical Learning”, we see that GAMs are both relatively flexible and interpretable, making them good for both prediction and inference.</p>
</section>
<section id="how-are-the-functions-determined" class="level2">
<h2 data-anchor-id="how-are-the-functions-determined">How are the functions determined?</h2>
<p>In GAMs, the smooth functions are typically created by <strong>splines</strong>. Splines are just <strong>piecewise polynomial functions</strong> that meet specific conditions to ensure smoothness across different segments of data.</p>
<p><strong>Why not use a single polynomial across all data?</strong></p>
<p>A single global polynomial can lead to poor fit, especially at the edges, and small changes in one part of the data can cause large changes elsewhere. This is called the <strong>Runge phenomenon</strong>, where high-degree polynomials oscillate and overfit in certain regions. Piecewise polynomials, or splines, resolve this by fitting local segments while ensuring smooth transitions across them.</p>
<p>Let’s walk through the progression of how these splines evolve from simple piecewise polynomials to the smooth functions used in GAMs.</p>
<section id="step-1-piecewise-polynomials-without-conditions" class="level4">
<h4 data-anchor-id="step-1-piecewise-polynomials-without-conditions">Step 1: Piecewise Polynomials without Conditions</h4>
<p>We can start by fitting <strong>piecewise cubic polynomials</strong> to different parts of the data. This means we divide the data into sections based on specific breakpoints and fit a cubic polynomial to each section independently.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="GAM_article_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this example, we set two breakpoints at ages 30 and 60, fitting three separate cubic polynomials to different sections of the data. However, without additional conditions, there’s a major issue: the polynomials do not connect smoothly at the breakpoints, leading to <strong>discontinuities</strong>. For instance, the predicted number of sit-ups might suddenly drop from 27 to 18 at age 60, which is unrealistic.</p>
</section>
<section id="step-2-ensuring-continuity" class="level4">
<h4 data-anchor-id="step-2-ensuring-continuity">Step 2: Ensuring Continuity</h4>
<p>To address this, we need to impose the condition that the function is <strong>continuous</strong> across the different segments. This means the pieces must meet at the breakpoints, so the function values are the same at the knots.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="GAM_article_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>After adding this continuity constraint, the splines are connected, and the function appears mostly smooth. However, in many cases, the function may still have abrupt changes at the breakpoints, or <em>knots</em>, even though it is continuous, looking something like this:<br>
<img src="images/splines2.png" class="img-fluid" width="362"></p>
</section>
<section id="step-3-ensuring-smoothness" class="level4">
<h4 data-anchor-id="step-3-ensuring-smoothness">Step 3: Ensuring Smoothness</h4>
<p>To create a smoother curve, we need to go a step further. In addition to making the function continuous, we also ensure the <strong>first and second derivatives</strong> (slope and curvature) are continuous at the breakpoints. This prevents sudden changes in the shape of the curve. GAMs do this automatically by using <strong>cubic splines</strong>.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a GAM model using cubic splines on the sampled data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>fit_spline_sampled <span class="ot">&lt;-</span> <span class="fu">gam</span>(sit_ups_counts <span class="sc">~</span> <span class="fu">s</span>(age), <span class="at">data =</span> sampled_data)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions from the model for the sampled data</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>sampled_data <span class="ot">&lt;-</span> sampled_data <span class="sc">|&gt;</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted_sit_ups =</span> <span class="fu">predict</span>(fit_spline_sampled, <span class="at">newdata =</span> sampled_data))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the sampled data and the fitted spline</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>p_spline_sampled <span class="ot">&lt;-</span> sampled_data <span class="sc">|&gt;</span> </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> sit_ups_counts)) <span class="sc">+</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> predicted_sit_ups), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Age"</span>, <span class="at">y =</span> <span class="st">"Number of sit-ups"</span>, <span class="at">title =</span> <span class="st">"Cubic Spline Fit"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>p_spline_sampled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="GAM_article_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>With these conditions, the function is now both <strong>continuous and smooth</strong>. The process of fitting these smooth splines is automated in tools like the <strong>mgcv</strong> package in R, which makes it easy to apply.</p>
<p><strong>How to choose the number of knots?</strong></p>
<p>It’s important to choose the right number of knots when fitting splines. Too few knots can make the model too rigid, while too many can lead to overfitting. Typically, the best number of knots is selected using <strong>cross-validation</strong>, which helps balance model complexity and performance.</p>
</section>
</section>
<section id="how-to-interpret-gams" class="level2">
<h2 data-anchor-id="how-to-interpret-gams">How to interpret GAMs?</h2>
<p>Although GAMs are more interpretable than more complex nonparametric models, they can still sometimes be hard to understand.</p>
<p>Continuing with previous example, let’s add body fat percent to the model so that now there are now multiple predictor variables. The model equation is now of the form:</p>
<p><span class="math display">\[f(x) = \beta_0 + s_1(\mathrm{age}) + s_2(\mathrm{body\_fat\_percent})\]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>gam_multiple <span class="ot">&lt;-</span> <span class="fu">gam</span>(sit_ups_counts <span class="sc">~</span> <span class="fu">s</span>(age) <span class="sc">+</span> <span class="fu">s</span>(body_fat_percent), <span class="at">data =</span> sampled_data)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>partial_effect_plot_multiple <span class="ot">&lt;-</span> <span class="fu">draw</span>(gam_multiple, <span class="at">residuals =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(partial_effect_plot_multiple) <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Partial effects of predictors on number of push-ups"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="GAM_article_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These partial effects plots show how much the variable on the x-axis increases or decreases the predicted response, <strong>assuming all the other variables stay constant</strong>.</p>
<p>For example, in the body fat plot, people with low body fat have a positive effect, meaning they can do more sit-ups. In contrast, people with higher body fat have a negative effect, meaning they tend to do fewer sit-ups.</p>
<section id="categorical-variables" class="level3">
<h3 data-anchor-id="categorical-variables">Categorical variables</h3>
<p>GAMs handle categorical variables just like linear regression—using <strong>dummy variables</strong>. This means one category is chosen as the baseline, and all other categories are compared to that baseline.</p>
<p>For example, here’s how the model handles gender:</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>sampled_data <span class="ot">&lt;-</span> sampled_data <span class="sc">|&gt;</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gender =</span> <span class="fu">as.factor</span>(gender))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>gam_cat <span class="ot">&lt;-</span> <span class="fu">gam</span>(sit_ups_counts <span class="sc">~</span> gender, <span class="at">data =</span> sampled_data, <span class="at">method =</span> <span class="st">"REML"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>partial_effect_plot_cat <span class="ot">&lt;-</span> <span class="fu">draw</span>(gam_cat, <span class="at">residuals =</span> <span class="cn">FALSE</span>, <span class="at">parametric =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>partial_effect_plot_cat <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Partial effects of gender on number of sit-ups"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Gender"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="GAM_article_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this case, female is the baseline, and the graph shows that males tend to do more sit-ups than females, with a positive partial effect. We can interpret this as:</p>
<p><em>“Males can do about 14 more sit-ups than females, assuming everything else is constant.”</em></p>
<p>The confidence interval shows we are 95% confident that the true difference is between 12 and 15 extra sit-ups.</p>
</section>
<section id="what-about-interactions" class="level3">
<h3 data-anchor-id="what-about-interactions">What about interactions?</h3>
<p>GAMs don’t automatically include interaction effects, but we can manually add them if we think the effect of one variable might depend on another.</p>
<p>For example, younger people with higher body fat might still perform well because they have more muscle and faster metabolisms. For older people, high body fat may have a stronger negative effect. Thus, we expect that <strong>the effect of body fat on number of sit-ups increases with age</strong>.</p>
<p>To model this interaction, we can include both age and bodyfatpercentage together.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>gam_interact <span class="ot">&lt;-</span> <span class="fu">gam</span>(sit_ups_counts <span class="sc">~</span> <span class="fu">te</span>(age, body_fat_percent), <span class="at">data =</span> sampled_data)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>partial_effect_plot_interact <span class="ot">&lt;-</span> <span class="fu">draw</span>(gam_interact, <span class="at">residuals =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>partial_effect_plot_interact <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"T"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="GAM_article_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this plot, the <strong>contour lines</strong> show the interaction between age and body fat. If the lines were straight, it would mean that age and body fat are affecting sit-ups independently. However, the <strong>curved lines</strong> suggest that the effect of body fat on sit-ups depends on a person’s age, and vice versa.</p>
<p>For example, body fat doesn’t have much effect for younger people (flat lines), but it has a stronger negative effect for older people (steeper lines).</p>
<p>If the variables are on different scales, you can use <code>te()</code> (tensor product) to model their interaction instead of <code>s()</code>.</p>
</section>
</section>
<section id="model-assumptions" class="level2">
<h2 data-anchor-id="model-assumptions">Model assumptions</h2>
<p>GAMs make several assumptions, some of which are similar to linear regression, while others are different.</p>
<ol type="1">
<li><p><strong>Smooth functions instead of linear relationships:</strong></p>
<p>Unlike linear regression where the predictors have linear relationships with the outcomes, for GAMs, the functions don’t have to be linear and can be anything that can be drawn as a squiggly line on a graph.</p>
<table class="table">
<thead>
<tr class="header">
<th>Model</th>
<th>Relationship type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Linear regression</td>
<td>Predictors must be linear</td>
</tr>
<tr class="even">
<td>GAMs</td>
<td>Predictors can be nonlinear</td>
</tr>
</tbody>
</table>
<p><em>How to check this assumption:</em> Visualize the smooth functions using partial effects plots to see if the shape of the smooth functions make sense given your data.</p></li>
<li><p><strong>Additivity of effects:</strong></p>
<p>Just as with linear regression, the effects of each of the variables on the outcome are added together to get the response.</p>
<table class="table">
<thead>
<tr class="header">
<th>Model</th>
<th>How effects are combined</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Linear regression</td>
<td>Effects are added together</td>
</tr>
<tr class="even">
<td>GAMs</td>
<td>Effects are added together</td>
</tr>
</tbody>
</table>
<p><em>How to check this assumption:</em> There is no direct diagnostic for this, but if you suspect interactions, try adding interaction terms and see if they significantly improve the model fit. If they do, the additivity assumption is insufficient.</p></li>
<li><p><strong>Independence of errors:</strong></p>
<p>Same as with linear regression, GAMs assume that the errors are independent of each other. This helps ensure that no important patterns or variables are missing from the model.</p>
<table class="table">
<thead>
<tr class="header">
<th>Model</th>
<th>Assumption</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Linear regression</td>
<td>Errors should be independent</td>
</tr>
<tr class="even">
<td>GAMs</td>
<td>Errors should be independent</td>
</tr>
</tbody>
</table>
<p><em>How to check this assumption:</em> plot the residuals against fitted values, or if you are using time series data, the Durbin-Watson test will check for autocorrelation of the residuals.</p></li>
<li><p><strong>Distribution of errors:</strong></p>
<p>The required distribution of errors in GAMs depends on the type of outcome variable:</p>
<ul>
<li><p>For a <strong>continuous</strong> response, the errors should be <strong>normally distributed</strong>.</p></li>
<li><p>For a <strong>binary</strong> response, the errors should follow a <strong>binomial distribution</strong>.</p></li>
<li><p>For <strong>count data</strong>, the errors should follow a <strong>Poisson distribution</strong>.</p></li>
</ul>
<table class="table">
<colgroup>
<col style="width: 25%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Relationship type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Linear regression</td>
<td>Normally distributed errors (if running hypothesis tests or calculating confidence intervals)</td>
</tr>
<tr class="even">
<td>GAMs</td>
<td>Distribution depends on distribution of response</td>
</tr>
</tbody>
</table>
<p><em>How to check this assumption:</em> If the outcome is continuous (like the number of sit-ups), we check if the errors are normally distributed by looking at QQ plots and histograms of residuals.</p></li>
</ol>
</section>
<section id="conclusion" class="level2">
<h2 data-anchor-id="conclusion">Conclusion</h2>
<p>The purpose of this article was to help build more intuition about how GAMs work and to help people determine if GAMs are appropriate for their use case.</p>
<p>We saw how GAMs are a balanced model in the sense that they are flexible enough to capture more complicated trends while still being simple enough where they can be easily interpreted. While GAMs are powerful, they do have their limitations like needing to handle interactions manually and needing to have a large enough data set to accurately capture the nonlinear patterns.</p>
</section>
<section id="references" class="level2">
<h2 data-anchor-id="references">References</h2>
<p>Basheer, K. C. S. (2024, August 12). <em>Understanding generalized additive models (GAMS): A comprehensive guide</em>. Analytics Vidhya. https://www.analyticsvidhya.com/blog/2023/09/understanding-generalized-additive-models-gams-a-comprehensive-guide/</p>
<p>Bottom of the Heap. (2020, July 30). <em>Introduction to Generalized Additive Models with R and mgcv</em>. YouTube. https://www.youtube.com/watch?v=sgw4cu8hrZM&amp;t=957s</p>
<p>Department of Statistics &amp; Data Science Carnegie Mellon University. (2024, July 2). <em>Supervised learning: Nonparametric regression</em>. SURE 2024. https://36-sure.github.io/lectures/18-nonparametric.html#/title-slide</p>
<p>James, G., Witten, D., Hastie, T., &amp; Tibshirani, R. (2023). <em>An introduction to statistical learning: With applications in R</em>. Springer.</p>
<p>Larsen, K. (2015, July 30). <em>Gam: The predictive modeling silver bullet</em>. MultiThreaded. https://multithreaded.stitchfix.com/blog/2015/07/30/gam/</p>
<p>Québec Centre for Biodiversity Science. (2023, April). <em>Workshop 8: Generalized additive models</em>. <em>QCBS R Workshop Series</em>.</p>
<p>Shafi, A. (2021, May 18). <em>What is a generalised additive model?</em>. Medium. https://towardsdatascience.com/generalised-additive-models-6dfbedf1350a</p>
<p>Simpson, G. (2022, January 7). <em>Statistical Methods Series: Generalized Additive Models (GAMs)</em>. YouTube. https://www.youtube.com/watch?v=Ukfvd8akfco</p>


</section>
</main></div>
    </div>
  </div>
</div>
 <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>